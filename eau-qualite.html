<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qualit√© de l'Eau - France</title>
    <style>
        /* ===== BASIC STYLING ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ===== HEADER ===== */
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: rgba(255,255,255,0.8);
            text-align: center;
            margin-bottom: 40px;
        }

        /* ===== SEARCH BOX ===== */
        .search-box {
            background: white;
            padding: 30px;
            border-radius: 35px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .search-button {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-button:hover {
            background: #5a6fd6;
        }

        .search-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ===== RESULTS AREA ===== */
        .results {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none; /* Hidden until we have results */
        }

        .results.visible {
            display: block;
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* ===== DATA CARDS ===== */
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .indicator-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .indicator-card.conforme {
            border-left-color: #28a745;
        }

        .indicator-card.non-conforme {
            border-left-color: #dc3545;
        }

        .indicator-card.info {
            border-left-color: #667eea;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .status-badge.conforme {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.non-conforme {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.info {
            background: #e7f1ff;
            color: #004085;
        }

        .indicator-note {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }

        .source-link {
            margin-top: 20px;
            font-size: 0.75rem;
            color: #888;
        }

        .source-link a {
            color: #667eea;
        }

        .indicator-name {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .indicator-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .indicator-unit {
            font-size: 0.9rem;
            color: #888;
        }

        .indicator-limit {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        .last-update {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíß Qualit√© de l'Eau</h1>
        <p class="subtitle">V√©rifiez la qualit√© de l'eau du robinet dans votre commune</p>

        <!-- SEARCH BOX -->
        <div class="search-box">
            <form class="search-form" id="searchForm">
                <input
                    type="text"
                    class="search-input"
                    id="cityInput"
                    placeholder="Entrez le nom de votre commune (ex: Lyon, Bordeaux...)"
                    required
                >
                <button type="submit" class="search-button" id="searchButton">
                    Rechercher
                </button>
            </form>
        </div>

        <!-- RESULTS AREA -->
        <div class="results" id="results">
            <!-- Results will be inserted here by JavaScript -->
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // Base URL for the Hub'Eau API
        const API_BASE = 'https://hubeau.eaufrance.fr/api/v1/qualite_eau_potable';

        // Key water quality parameters to display
        // Official limits from: Arr√™t√© du 11 janvier 2007 (modified 30 d√©cembre 2022)
        // Source: https://www.legifrance.gouv.fr/loda/id/JORFTEXT000000465574
        const KEY_PARAMETERS = {
            // === Parameters with LEGAL LIMITS (health-related) ===
            '1340': { name: 'Nitrates', unit: 'mg/L', limit: 50, hasLimit: true },
            '1350': { name: 'Nitrites', unit: 'mg/L', limit: 0.5, hasLimit: true },
            '1302': { name: 'Chlorures', unit: 'mg/L', limit: 250, hasLimit: true },
            '1338': { name: 'Sulfates', unit: 'mg/L', limit: 250, hasLimit: true },
            '1347': { name: 'pH', unit: '', limitMin: 6.5, limitMax: 9, hasLimit: true },
            // === Parameters WITHOUT limits (informational only) ===
            // These minerals are beneficial - no health risk
            '1305': {
                name: 'Calcium',
                unit: 'mg/L',
                hasLimit: false,
                richThreshold: 120,  // "Riche en calcium" if above
                infoType: 'mineral'
            },
            '1319': {
                name: 'Magn√©sium',
                unit: 'mg/L',
                hasLimit: false,
                richThreshold: 56,  // "Riche en magn√©sium" if above
                infoType: 'mineral'
            },
            '1303': {
                name: 'Potassium',
                unit: 'mg/L',
                hasLimit: false,
                infoType: 'mineral'
            },
            '1372': {
                name: 'Duret√© (TH)',
                unit: '¬∞f',
                hasLimit: false,
                infoType: 'hardness',
                // Ranges: 0-8 tr√®s douce, 8-15 id√©ale, 15-25 acceptable, 25-30 moyennement dure, >30 dure
                ranges: [
                    { max: 8, label: 'Tr√®s douce', note: 'Peut corroder les canalisations' },
                    { max: 15, label: 'Id√©ale', note: 'Bon √©quilibre min√©raux/calcaire' },
                    { max: 25, label: 'Acceptable', note: 'L√©g√®rement calcaire' },
                    { max: 30, label: 'Moyennement dure', note: 'D√©p√¥ts possibles' },
                    { max: Infinity, label: 'Dure', note: 'Risque de tartre' }
                ]
            },
        };

        // ===== DOM ELEMENTS =====
        const searchForm = document.getElementById('searchForm');
        const cityInput = document.getElementById('cityInput');
        const searchButton = document.getElementById('searchButton');
        const resultsDiv = document.getElementById('results');

        // ===== EVENT LISTENER =====
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Don't reload the page
            const cityName = cityInput.value.trim();
            if (cityName) {
                await searchCity(cityName);
            }
        });

        // ===== MAIN SEARCH FUNCTION =====
        async function searchCity(cityName) {
            // Show loading state
            resultsDiv.classList.add('visible');
            resultsDiv.innerHTML = '<div class="loading">üîç Recherche en cours...</div>';
            searchButton.disabled = true;

            try {
                // Step 1: Find the commune in the API
                const communeResponse = await fetch(
                    `${API_BASE}/communes_udi?nom_commune=${encodeURIComponent(cityName)}&size=1`
                );
                const communeData = await communeResponse.json();

                if (!communeData.data || communeData.data.length === 0) {
                    throw new Error(`Commune "${cityName}" non trouv√©e. V√©rifiez l'orthographe.`);
                }

                const commune = communeData.data[0];
                const codeCommune = commune.code_commune;
                const nomCommune = commune.nom_commune;

                // Step 2: Get water quality results for this commune
                const resultsResponse = await fetch(
                    `${API_BASE}/resultats_dis?code_commune=${codeCommune}&size=200`
                );
                const resultsData = await resultsResponse.json();

                if (!resultsData.data || resultsData.data.length === 0) {
                    throw new Error(`Pas de donn√©es disponibles pour ${nomCommune}.`);
                }

                // Step 3: Display the results
                displayResults(nomCommune, resultsData.data);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            } finally {
                searchButton.disabled = false;
            }
        }

        // ===== DISPLAY RESULTS =====
        function displayResults(communeName, data) {
            // Group results by parameter, keeping only the most recent
            const latestByParam = {};
            let mostRecentDate = null;

            for (const result of data) {
                const code = result.code_parametre;
                const date = new Date(result.date_prelevement);

                // Track most recent date overall
                if (!mostRecentDate || date > mostRecentDate) {
                    mostRecentDate = date;
                }

                // Keep only the most recent result for each parameter
                if (!latestByParam[code] || date > new Date(latestByParam[code].date_prelevement)) {
                    latestByParam[code] = result;
                }
            }

            // Build the HTML
            let cardsHtml = '';

            for (const [code, info] of Object.entries(KEY_PARAMETERS)) {
                const result = latestByParam[code];
                if (result && result.resultat_numerique !== null) {
                    const value = result.resultat_numerique;
                    const status = getStatus(value, info);

                    // Build limit text
                    let limitText = '';
                    if (info.limitMin !== undefined && info.limitMax !== undefined) {
                        limitText = `Limite: ${info.limitMin} - ${info.limitMax}`;
                    } else if (info.limit) {
                        limitText = `Limite: ${info.limit} ${info.unit}`;
                    }

                    // Build status badge and info label
                    let statusBadge = '';
                    let infoNote = '';

                    if (info.hasLimit) {
                        // Parameters with legal limits: show CONFORME/NON CONFORME
                        const badgeText = status === 'conforme' ? 'CONFORME' : 'NON CONFORME';
                        statusBadge = `<span class="status-badge ${status}">${badgeText}</span>`;
                    } else {
                        // Informational parameters: show mineral/hardness info
                        const infoLabel =   Label(value, info);
                        if (infoLabel) {
                            statusBadge = `<span class="status-badge info">${infoLabel.label}</span>`;
                            infoNote = `<div class="indicator-note">${infoLabel.note}</div>`;
                        }
                    }

                    cardsHtml += `
                        <div class="indicator-card ${status}">
                            <div class="indicator-name">${info.name}</div>
                            <div class="indicator-value">
                                ${value} <span class="indicator-unit">${info.unit}</span>
                            </div>
                            ${limitText ? `<div class="indicator-limit">${limitText}</div>` : ''}
                            ${statusBadge}
                            ${infoNote}
                        </div>
                    `;
                }
            }

            // If no cards, show a message
            if (!cardsHtml) {
                cardsHtml = '<p>Aucun indicateur cl√© disponible pour cette commune.</p>';
            }

            resultsDiv.innerHTML = `
                <h2>üìç ${communeName}</h2>
                <div class="indicator-grid">
                    ${cardsHtml}
                </div>
                <div class="last-update">
                    Derni√®re analyse: ${mostRecentDate ? mostRecentDate.toLocaleDateString('fr-FR') : 'Inconnue'}
                </div>
                <div class="source-link">
                    Limites r√©glementaires: <a href="https://www.legifrance.gouv.fr/loda/id/JORFTEXT000000465574" target="_blank">Arr√™t√© du 11 janvier 2007</a>
                </div>
            `;
        }

        // ===== HELPER: Determine conformity status =====
        // Based on official French limits (Arr√™t√© du 11 janvier 2007)
        function getStatus(value, paramInfo) {
            if (!paramInfo.hasLimit) return 'info'; // No legal limit = informational only

            // Special handling for pH (range limit)
            if (paramInfo.limitMin !== undefined && paramInfo.limitMax !== undefined) {
                if (value >= paramInfo.limitMin && value <= paramInfo.limitMax) {
                    return 'conforme';
                }
                return 'non-conforme';
            }

            // Standard single limit (must be <= limit)
            if (value <= paramInfo.limit) {
                return 'conforme';
            }
            return 'non-conforme';
        }

        // ===== HELPER: Get informational label for minerals =====
        function getInfoLabel(value, paramInfo) {
            if (paramInfo.hasLimit) return null; // Only for informational parameters

            // Hardness (Duret√©) - has specific ranges
            if (paramInfo.infoType === 'hardness' && paramInfo.ranges) {
                for (const range of paramInfo.ranges) {
                    if (value <= range.max) {
                        return {
                            label: range.label,
                            note: range.note
                        };
                    }
                }
            }

            // Minerals (Calcium, Magn√©sium, Potassium)
            if (paramInfo.infoType === 'mineral') {
                let label = 'Min√©ral b√©n√©fique';
                let note = 'Sans risque pour la sant√©';

                // Check if water is "rich" in this mineral
                if (paramInfo.richThreshold && value > paramInfo.richThreshold) {
                    note = `Eau riche en ${paramInfo.name.toLowerCase()}`;
                }

                return { label, note };
            }

            return null;
        }
    </script>
</body>
</html>
